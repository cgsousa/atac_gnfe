{$A8,B-,C+,D+,E-,F-,G+,H+,I+,J-,K-,L+,M-,N-,O+,P+,Q-,R-,S-,T-,U-,V+,W-,X+,Y+,Z1}
{$MINSTACKSIZE $00004000}
{$MAXSTACKSIZE $00100000}
{$IMAGEBASE $00400000}
{$APPTYPE GUI}
{$WARN SYMBOL_DEPRECATED ON}
{$WARN SYMBOL_LIBRARY ON}
{$WARN SYMBOL_PLATFORM ON}
{$WARN SYMBOL_EXPERIMENTAL ON}
{$WARN UNIT_LIBRARY ON}
{$WARN UNIT_PLATFORM ON}
{$WARN UNIT_DEPRECATED ON}
{$WARN UNIT_EXPERIMENTAL ON}
{$WARN HRESULT_COMPAT ON}
{$WARN HIDING_MEMBER ON}
{$WARN HIDDEN_VIRTUAL ON}
{$WARN GARBAGE ON}
{$WARN BOUNDS_ERROR ON}
{$WARN ZERO_NIL_COMPAT ON}
{$WARN STRING_CONST_TRUNCED ON}
{$WARN FOR_LOOP_VAR_VARPAR ON}
{$WARN TYPED_CONST_VARPAR ON}
{$WARN ASG_TO_TYPED_CONST ON}
{$WARN CASE_LABEL_RANGE ON}
{$WARN FOR_VARIABLE ON}
{$WARN CONSTRUCTING_ABSTRACT ON}
{$WARN COMPARISON_FALSE ON}
{$WARN COMPARISON_TRUE ON}
{$WARN COMPARING_SIGNED_UNSIGNED ON}
{$WARN COMBINING_SIGNED_UNSIGNED ON}
{$WARN UNSUPPORTED_CONSTRUCT ON}
{$WARN FILE_OPEN ON}
{$WARN FILE_OPEN_UNITSRC ON}
{$WARN BAD_GLOBAL_SYMBOL ON}
{$WARN DUPLICATE_CTOR_DTOR ON}
{$WARN INVALID_DIRECTIVE ON}
{$WARN PACKAGE_NO_LINK ON}
{$WARN PACKAGED_THREADVAR ON}
{$WARN IMPLICIT_IMPORT ON}
{$WARN HPPEMIT_IGNORED ON}
{$WARN NO_RETVAL ON}
{$WARN USE_BEFORE_DEF ON}
{$WARN FOR_LOOP_VAR_UNDEF ON}
{$WARN UNIT_NAME_MISMATCH ON}
{$WARN NO_CFG_FILE_FOUND ON}
{$WARN IMPLICIT_VARIANTS ON}
{$WARN UNICODE_TO_LOCALE ON}
{$WARN LOCALE_TO_UNICODE ON}
{$WARN IMAGEBASE_MULTIPLE ON}
{$WARN SUSPICIOUS_TYPECAST ON}
{$WARN PRIVATE_PROPACCESSOR ON}
{$WARN UNSAFE_TYPE OFF}
{$WARN UNSAFE_CODE OFF}
{$WARN UNSAFE_CAST OFF}
{$WARN OPTION_TRUNCATED ON}
{$WARN WIDECHAR_REDUCED ON}
{$WARN DUPLICATES_IGNORED ON}
{$WARN UNIT_INIT_SEQ ON}
{$WARN LOCAL_PINVOKE ON}
{$WARN MESSAGE_DIRECTIVE ON}
{$WARN TYPEINFO_IMPLICITLY_ADDED ON}
{$WARN RLINK_WARNING ON}
{$WARN IMPLICIT_STRING_CAST ON}
{$WARN IMPLICIT_STRING_CAST_LOSS ON}
{$WARN EXPLICIT_STRING_CAST OFF}
{$WARN EXPLICIT_STRING_CAST_LOSS OFF}
{$WARN CVT_WCHAR_TO_ACHAR ON}
{$WARN CVT_NARROWING_STRING_LOST ON}
{$WARN CVT_ACHAR_TO_WCHAR OFF}
{$WARN CVT_WIDENING_STRING_LOST OFF}
{$WARN XML_WHITESPACE_NOT_ALLOWED ON}
{$WARN XML_UNKNOWN_ENTITY ON}
{$WARN XML_INVALID_NAME_START ON}
{$WARN XML_INVALID_NAME ON}
{$WARN XML_EXPECTED_CHARACTER ON}
{$WARN XML_CREF_NO_RESOLVE ON}
{$WARN XML_NO_PARM ON}
{$WARN XML_NO_MATCHING_PARM ON}
{$A8,B-,C+,D+,E-,F-,G+,H+,I+,J-,K-,L+,M-,N-,O+,P+,Q-,R-,S-,T-,U-,V+,W-,X+,Y+,Z1}
{$MINSTACKSIZE $00004000}
{$MAXSTACKSIZE $00100000}
{$IMAGEBASE $00400000}
{$APPTYPE GUI}
{$WARN SYMBOL_DEPRECATED ON}
{$WARN SYMBOL_LIBRARY ON}
{$WARN SYMBOL_PLATFORM ON}
{$WARN SYMBOL_EXPERIMENTAL ON}
{$WARN UNIT_LIBRARY ON}
{$WARN UNIT_PLATFORM ON}
{$WARN UNIT_DEPRECATED ON}
{$WARN UNIT_EXPERIMENTAL ON}
{$WARN HRESULT_COMPAT ON}
{$WARN HIDING_MEMBER ON}
{$WARN HIDDEN_VIRTUAL ON}
{$WARN GARBAGE ON}
{$WARN BOUNDS_ERROR ON}
{$WARN ZERO_NIL_COMPAT ON}
{$WARN STRING_CONST_TRUNCED ON}
{$WARN FOR_LOOP_VAR_VARPAR ON}
{$WARN TYPED_CONST_VARPAR ON}
{$WARN ASG_TO_TYPED_CONST ON}
{$WARN CASE_LABEL_RANGE ON}
{$WARN FOR_VARIABLE ON}
{$WARN CONSTRUCTING_ABSTRACT ON}
{$WARN COMPARISON_FALSE ON}
{$WARN COMPARISON_TRUE ON}
{$WARN COMPARING_SIGNED_UNSIGNED ON}
{$WARN COMBINING_SIGNED_UNSIGNED ON}
{$WARN UNSUPPORTED_CONSTRUCT ON}
{$WARN FILE_OPEN ON}
{$WARN FILE_OPEN_UNITSRC ON}
{$WARN BAD_GLOBAL_SYMBOL ON}
{$WARN DUPLICATE_CTOR_DTOR ON}
{$WARN INVALID_DIRECTIVE ON}
{$WARN PACKAGE_NO_LINK ON}
{$WARN PACKAGED_THREADVAR ON}
{$WARN IMPLICIT_IMPORT ON}
{$WARN HPPEMIT_IGNORED ON}
{$WARN NO_RETVAL ON}
{$WARN USE_BEFORE_DEF ON}
{$WARN FOR_LOOP_VAR_UNDEF ON}
{$WARN UNIT_NAME_MISMATCH ON}
{$WARN NO_CFG_FILE_FOUND ON}
{$WARN IMPLICIT_VARIANTS ON}
{$WARN UNICODE_TO_LOCALE ON}
{$WARN LOCALE_TO_UNICODE ON}
{$WARN IMAGEBASE_MULTIPLE ON}
{$WARN SUSPICIOUS_TYPECAST ON}
{$WARN PRIVATE_PROPACCESSOR ON}
{$WARN UNSAFE_TYPE OFF}
{$WARN UNSAFE_CODE OFF}
{$WARN UNSAFE_CAST OFF}
{$WARN OPTION_TRUNCATED ON}
{$WARN WIDECHAR_REDUCED ON}
{$WARN DUPLICATES_IGNORED ON}
{$WARN UNIT_INIT_SEQ ON}
{$WARN LOCAL_PINVOKE ON}
{$WARN MESSAGE_DIRECTIVE ON}
{$WARN TYPEINFO_IMPLICITLY_ADDED ON}
{$WARN RLINK_WARNING ON}
{$WARN IMPLICIT_STRING_CAST ON}
{$WARN IMPLICIT_STRING_CAST_LOSS ON}
{$WARN EXPLICIT_STRING_CAST OFF}
{$WARN EXPLICIT_STRING_CAST_LOSS OFF}
{$WARN CVT_WCHAR_TO_ACHAR ON}
{$WARN CVT_NARROWING_STRING_LOST ON}
{$WARN CVT_ACHAR_TO_WCHAR OFF}
{$WARN CVT_WIDENING_STRING_LOST OFF}
{$WARN XML_WHITESPACE_NOT_ALLOWED ON}
{$WARN XML_UNKNOWN_ENTITY ON}
{$WARN XML_INVALID_NAME_START ON}
{$WARN XML_INVALID_NAME ON}
{$WARN XML_EXPECTED_CHARACTER ON}
{$WARN XML_CREF_NO_RESOLVE ON}
{$WARN XML_NO_PARM ON}
{$WARN XML_NO_MATCHING_PARM ON}
unit Form.ManifestoList;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, ExtCtrls, Mask,

  AdvToolBar, AdvOfficeStatusBar, AdvOfficeButtons, AdvEdit,
  AdvGroupBox, AdvPanel, AdvGlowButton,

  JvExStdCtrls, JvButton, JvCtrls, JvExMask, JvToolEdit,

  FormBase, uStatusBar, VirtualTrees, uVSTree,
  JvFooter, JvExExtCtrls, JvExtComponent, Menus, AdvMenus,
  ActnList,

  uACBrMDFe, uIntf, uManifestoCtr
  ;

type
  Tfrm_ManifestoList = class(TBaseForm, IView)
    AdvOfficeStatusBar1: TAdvOfficeStatusBar;
    vst_Grid1: TVirtualStringTree;
    pnl_Filter: TAdvPanel;
    gbx_DtEmis: TAdvGroupBox;
    edt_DatIni: TJvDateEdit;
    edt_DatFin: TJvDateEdit;
    rgx_Status: TAdvOfficeRadioGroup;
    btn_Find: TJvImgBtn;
    gbx_Ident: TAdvGroupBox;
    edt_CodSeq: TAdvEdit;
    chk_ChvNFe: TAdvOfficeCheckBox;
    pnl_Footer: TJvFooter;
    btn_Config: TJvFooterBtn;
    btn_Filter: TJvFooterBtn;
    btn_Close: TJvFooterBtn;
    btn_Send: TJvFooterBtn;
    btn_Cons: TJvFooterBtn;
    btn_New: TJvFooterBtn;
    btn_ConsSvc: TJvFooterBtn;
    btn_Evento: TJvFooterBtn;
    btn_Print: TJvFooterBtn;
    ActionList1: TActionList;
    act_New: TAction;
    act_Edit: TAction;
    pm_Emissao: TAdvPopupMenu;
    Emisso1: TMenuItem;
    Alterar1: TMenuItem;
    act_Browse: TAction;
    Visualizar1: TMenuItem;
    procedure FormShow(Sender: TObject);
    procedure btn_FindClick(Sender: TObject);
    procedure vst_Grid1GetText(Sender: TBaseVirtualTree; Node: PVirtualNode;
      Column: TColumnIndex; TextType: TVSTTextType; var CellText: string);
    procedure btn_FilterClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure btn_SendClick(Sender: TObject);
    procedure btn_ConfigClick(Sender: TObject);
    procedure btn_CloseClick(Sender: TObject);
    procedure vst_Grid1Change(Sender: TBaseVirtualTree; Node: PVirtualNode);
    procedure btn_ConsSvcClick(Sender: TObject);
    procedure btn_PrintClick(Sender: TObject);
    procedure act_NewExecute(Sender: TObject);
    procedure act_EditExecute(Sender: TObject);
    procedure btn_EventoClick(Sender: TObject);
    procedure btn_ConsClick(Sender: TObject);
    procedure act_BrowseExecute(Sender: TObject);
  private
    { Private declarations }
    m_Ctrl: TCManifestoCtr;
    m_Param: TRegMDFe;
    procedure Inicialize;
  protected
    { StatusBar }
    m_StatusBar: TCStatusBarWidget;
    m_panelAmb: TAdvOfficeStatusPanel ;
    m_panelItems: TAdvOfficeStatusPanel ;
    m_panelVTotal: TAdvOfficeStatusPanel ;
    m_panelProgress: TAdvOfficeStatusPanel ;
    m_panelText: TAdvOfficeStatusPanel ;
    procedure setStatusBar(const aPos: Int64 =0) ;
  public
    { Public declarations }
    procedure ModelChanged;
    procedure Execute;
  end;

var
  frm_ManifestoList: Tfrm_ManifestoList ;


implementation

uses StrUtils, DateUtils,
  pcnConversao, pmdfeConversaoMDFe, ACBrUtil, ACBrMDFeManifestos,
  uTaskDlg, uadodb, udbconst, ucademp, uManifestoDF, ustr ,
  fdm.Styles, Form.Manifesto, Form.ParametroList, Form.EventoMDFe;



{$R *.dfm}

{ Tfrm_ManifestoList }

procedure Tfrm_ManifestoList.act_BrowseExecute(Sender: TObject);
var
  M: IManifestoDF;
  V: IView ;
begin

    M :=m_Ctrl.ModelList.Items[vst_Grid1.IndexItem] ;
    if(M <> nil)and(M.id > 0) then
    begin
        V :=Tfrm_Manifesto.Create(m_Ctrl);
        m_Ctrl.Model :=M ;
        m_Ctrl.Model.State :=msBrowse;
        m_Ctrl.Model.OnModelChanged :=(V as Tfrm_Manifesto).ModelChanged ;
        //m_Ctrl.Inicialize ;
        V.Execute ;
    end;

    ActiveControl :=vst_Grid1 ;
end;

procedure Tfrm_ManifestoList.act_EditExecute(Sender: TObject);
var
  M: IManifestoDF;
  V: IView ;
begin
    if CMsgDlg.Confirm('Deseja alterar o manifesto?') then
    begin
        M :=m_Ctrl.ModelList.Items[vst_Grid1.IndexItem] ;
        if(M <> nil)and(M.id > 0) then
        begin
            V :=Tfrm_Manifesto.Create(m_Ctrl);
            m_Ctrl.Model :=M ;
            m_Ctrl.Edit;
            m_Ctrl.Model.OnModelChanged :=(V as Tfrm_Manifesto).ModelChanged ;
            //m_Ctrl.Inicialize ;
            V.Execute ;
        end;
    end;
    ActiveControl :=vst_Grid1 ;
end;

procedure Tfrm_ManifestoList.act_NewExecute(Sender: TObject);
var
  M: IManifestoDF;
  V: IView ;
begin
    if CMsgDlg.Confirm('Deseja emitir um novo manifesto?') then
    begin
        M :=TCManifestoDF.Create ;
        V :=Tfrm_Manifesto.Create(m_Ctrl);
        m_Ctrl.Model:=M;
        m_Ctrl.Model.OnModelChanged :=(V as Tfrm_Manifesto).ModelChanged ;
        m_Ctrl.Insert;
        //m_Ctrl.Model.OnModelChanged :=(V as Tfrm_Manifesto).ModelChanged ;
        m_Ctrl.View :=V;
        //m_Ctrl.Inicialize ;
        V.Execute ;
    end;
    ActiveControl :=vst_Grid1 ;
end;

procedure Tfrm_ManifestoList.btn_EventoClick(Sender: TObject);
var
  E: IView ;
  rep: IBaseACBrMDFe;
begin

    //
    // ler manifesto selecionado
    m_Ctrl.Model :=m_Ctrl.ModelList.Items[vst_Grid1.IndexItem] ;
    if(m_Ctrl.Model <> nil)and(m_Ctrl.Model.Status in[100]) then
    begin
        rep :=TCBaseACBrMDFe.New(True, m_Param) ;
        E :=Tfrm_EventoMDFe.New(m_Ctrl.Model, rep) ;
        E.Execute ;
    end;

end;

procedure Tfrm_ManifestoList.btn_CloseClick(Sender: TObject);
begin
    Self.Close ;

end;

procedure Tfrm_ManifestoList.btn_ConfigClick(Sender: TObject);
var
  pwd: string ;
begin
    if not InputQueryDlg('Acesso aos Parametros do MDF-e','Informe a senha:', pwd) then
    begin
        Exit;
    end;
    if not ChkPwd(pwd) then
    begin
        CMsgDlg.Warning('Senha inválida!') ;
        Exit;
    end;
    //
    //
    //
    Tfrm_ParametroList.lp_Show('MDFE') ;
    m_Param.Load ;
end;

procedure Tfrm_ManifestoList.btn_ConsClick(Sender: TObject);
var
  rep: IBaseACBrMDFe;
  M: Manifesto ;
begin
    if CMsgDlg.Confirm('Deseja consultar a situação do MDF-e?')then
    begin
        //
        // ler manifesto selecionado
        m_Ctrl.Model :=m_Ctrl.ModelList.Items[vst_Grid1.IndexItem] ;

        setStatus('Consultando situação do MDF-e'#13#10'Aguarde...',crHourGlass);
        try
          rep :=TCBaseACBrMDFe.New(True, m_Param) ;
          if rep.consSitMDFe(m_Ctrl.Model) then
          begin
              CMsgDlg.Info('%d|%s',[rep.ErrCod,rep.ErrMsg]) ;
              //setStatus('Carregando a grade de dados');
              //LoadGrid ;
          end
          else begin
              CMsgDlg.Warning(Format('%d-%s',[rep.ErrCod,rep.ErrMsg])) ;
          end;

        finally
          setStatus('');
        end;

    end;
    ActiveControl :=vst_Grid1;
end;

procedure Tfrm_ManifestoList.btn_ConsSvcClick(Sender: TObject);
var
  rep: IBaseACBrMDFe ;
begin
    if CMsgDlg.Confirm('Deseja consultar o status do serviço?') then
    begin
        setStatus('Cominucando, aguarde...');
        try
          rep :=TCBaseACBrMDFe.New(True, m_Param) ;
          if rep.OnlyStatusSvc then
          begin
              CMsgDlg.Info(rep.mdfe.WebServices.StatusServico.Msg) ;
          end
          else begin
              CMsgDlg.Warning(rep.ErrMsg) ;
          end;
        finally
          setStatus('');
        end;
    end;
    ActiveControl :=vst_Grid1;
end;

procedure Tfrm_ManifestoList.btn_FilterClick(Sender: TObject);
begin
    pnl_Filter.Visible :=not pnl_Filter.Visible ;

end;

procedure Tfrm_ManifestoList.btn_FindClick(Sender: TObject);
var
  F: TManifestoFilter ;
begin
    //
    F.codseq :=0;
    F.datini :=0;
    F.datfin :=0;
    F.status :=mfsNone ;

    //
    //
    if edt_CodSeq.IntValue > 0 then
    begin
        F.codseq :=edt_CodSeq.IntValue ;
    end
    //
    //
    else begin
        F.datini :=edt_DatIni.Date ;
        F.datfin :=edt_DatFin.Date ;

        case rgx_Status.ItemIndex of
            0: F.status :=mfsDoneSend;
            1: F.status :=mfsConting ;
            2: F.status :=mfsProcess ;
            3: F.status :=mfsCancel ;
            4: F.status :=mfsError ;
        else
            if edt_DatIni.Date > edt_DatFin.Date then
            begin
                CMsgDlg.Info('Data inicial maior que data final!') ;
                edt_DatIni.SetFocus;
                exit;
            end;
        end;
    end;

    vst_Grid1.Clear ;
    if m_Ctrl.ModelList.Load(F) then
    begin
        vst_Grid1.RootNodeCount :=m_Ctrl.ModelList.Items.Count;
        vst_Grid1.IndexItem :=0;
        btn_Filter.Click ;
        act_Browse.Enabled  :=True;
        ActiveControl :=vst_Grid1;
    end
    else begin
        CMsgDlg.Info('Nenhuma manifesto encontrado neste filtro!') ;
        act_Browse.Enabled  :=False;
        ActiveControl :=edt_DatIni;
    end;
end;

procedure Tfrm_ManifestoList.btn_PrintClick(Sender: TObject);
var
  M: Manifesto ;
  rep: IBaseACBrMDFe;
begin
    if CMsgDlg.Confirm('Deseja imprimir o documento auxiliar?')then
    begin
        //
        // ler manifesto selecionado
        m_Ctrl.Model :=m_Ctrl.ModelList.Items[vst_Grid1.IndexItem] ;
        if(m_Ctrl.Model <> nil)and(m_Ctrl.Model.Status in[9,100]) then
        begin
            rep :=TCBaseACBrMDFe.New(True, m_Param) ;
            rep.PrintDAMDFe(m_Ctrl.Model) ;
        end;
    end;
end;

procedure Tfrm_ManifestoList.btn_SendClick(Sender: TObject);
var
  rep: IBaseACBrMDFe;
  M: Manifesto ;
//  F: TManifestoFilter;
begin
    if CMsgDlg.Confirm('Deseja autorizar o USO do manifesto?')then
    begin
        rep :=TCBaseACBrMDFe.New(True, m_Param) ;
        setStatus('Processando o Manifesto'#13#10'Aguarde...', crHourGlass);
        try
            //
            // ler manifesto selecionado
            m_Ctrl.Model :=m_Ctrl.ModelList.Items[vst_Grid1.IndexItem] ;
            if(m_Ctrl.Model <> nil)then //and(m_Ctrl.Model.Merge =mukModify) then
            begin
//                F.Create(m_Ctrl.Model.id);
//                m_Ctrl.Model.cmdFind(F)  ;
//                ret :=rep.OnlySendMDFE(m_Ctrl.Model) ;
//                setStatus('');
                if rep.OnlySend(m_Ctrl.Model) then
                begin
                    M :=rep.mdfe.Manifestos.Items[0] ;
                    m_Ctrl.Model.setRet(
                        M.MDFe.procMDFe.cStat ,
                        M.MDFe.procMDFe.xMotivo,
                        M.MDFe.procMDFe.verAplic,
                        rep.mdfe.WebServices.Retorno.Recibo,
                        M.MDFe.procMDFe.nProt,
                        M.MDFe.procMDFe.digVal ,
                        M.MDFe.procMDFe.dhRecbto);
                    CMsgDlg.Info('%d-%s',[m_Ctrl.Model.Status,m_Ctrl.Model.motivo])
                end
                else
                    CMsgDlg.Warning(rep.ErrMsg);
            end;
        finally
            setStatus('');
        end;
    end;
    ActiveControl :=vst_Grid1 ;
end;

procedure Tfrm_ManifestoList.Execute;
begin

end;

procedure Tfrm_ManifestoList.FormCreate(Sender: TObject);
begin
    Caption :=Application.Title ;

    //
    // statusBar
    m_StatusBar :=TCStatusBarWidget.Create(AdvOfficeStatusBar1, False);
    m_panelAmb:=m_StatusBar.AddPanel(psHTML, '', 90, taCenter) ;
    m_panelItems:=m_StatusBar.AddPanel(psHTML, '', 80, taCenter) ;
    m_panelVTotal:=m_StatusBar.AddPanel(psHTML, '', 140, taRightJustify) ;
    m_panelProgress:=m_StatusBar.AddPanel(psProgress, '', 250) ;
    m_panelText:=m_StatusBar.AddPanel(psHTML) ;

    //
    // conn
    ConnectionADO :=NewADOConnFromIniFile('Configuracoes.ini') ;

    if AdoConnect('') then
    begin
        CadEmp:=TCCadEmp.New(1) ;
//        m_Rep :=TCBaseACBrMDFe.New();
        m_Param.Load ;
        AdoDisconnect ;
    end;
end;

procedure Tfrm_ManifestoList.FormShow(Sender: TObject);
begin
    Self.Inicialize ;

end;

procedure Tfrm_ManifestoList.Inicialize;
begin
    m_Ctrl :=TCManifestoCtr.Create ;

    edt_DatIni.Date :=StartOfTheMonth(Date);
    edt_DatFin.Date :=Date;

    ActiveControl :=edt_DatIni;

    act_Edit.Enabled  :=False;
    act_Browse.Enabled  :=False;
    btn_Send.Enabled:=False;
    btn_Print.Enabled:=False;
    btn_Cons.Enabled:=False;

    btn_Evento.Enabled:=False;

    vst_Grid1.Clear ;

    setStatusBar();
end;

procedure Tfrm_ManifestoList.ModelChanged;
begin
    Self.Inicialize ;

end;

procedure Tfrm_ManifestoList.setStatusBar(const aPos: Int64) ;
var
  M: IManifestoDF ;
var
  s_frmt, s_text: string;
  process, cancel: Boolean ;
begin
    if aPos > 0 then
    begin
        m_panelProgress.Progress.Position :=aPos ;
    end
    else begin
        //
        // ind. tipo ambiente
        if m_Param.amb_pro.Value then
        begin
            s_frmt :='<p><font color="#FFFFFF" bgcolor="#00BF00"><b>%s</b></font</p>';
            s_text :=PadCenter('Produção', 13) ;
        end
        else begin
            s_frmt :='<p><font color="#FFFFFF" bgcolor="#FF0000"><b>%s</b></font</p>';
            s_text :=PadCenter('Homologação', 13) ;
        end;
        m_panelAmb.Text :=Format(s_frmt,[s_text]);

        if m_Ctrl.ModelList.Items.Count > 0 then
        begin
            M :=m_Ctrl.ModelList.Items[vst_Grid1.IndexItem];
            m_panelItems.Text :=Format('s:<b>%d</b>',[m_Ctrl.ModelList.Items.Count]);
            //m_panelVTotal.Text :=Format('Total:<b>%10.2m</b>',[m_Lote.vTotalNF]);

            //
            // ckk doc processado
            process :=M.Status in[100, 110, 150];
            process :=process or
                      (M.Status =301)or
                      (M.Status =302)or
                      (M.Status =303);
            //
            // ckk doc cancelado
            cancel  :=M.Status in[101, 151, 155];

            if process then
            begin
                m_panelText.Text :=Format('<p>Situação: <font color="#006400">%s</font</p>',[M.motivo]);
            end
            else if cancel then
            begin
                m_panelText.Text :=Format('<p>Situação: <font color="#FF8C00">%s</font</p>',[M.motivo]);
            end
            else begin
              m_panelText.Text :=Format('<p>Situação: <font color="#8B0000">%s</font</p>',[M.motivo]);
            end;
        end
        else begin
            m_panelItems.Text :='Nenhum';
            m_panelVTotal.Text :='';
            m_panelText.Text :='';
            m_panelProgress.Progress.Position :=0;
        end;
    end;
end;

procedure Tfrm_ManifestoList.vst_Grid1Change(Sender: TBaseVirtualTree;
  Node: PVirtualNode);
var
  M: IManifestoDF ;
  process, cancel: Boolean ;
begin
    if Assigned(Node) then
    begin
        //
        // extract manifesto
        M :=m_Ctrl.ModelList.Items[Node.Index] ;

        //
        // ckk doc processado
        process :=M.Status in[100, 110, 150];
        process :=process or
                  (M.Status =301)or
                  (M.Status =302)or
                  (M.Status =303);
        //
        // ckk doc cancelado
        cancel  :=M.Status in[101, 151, 155];

        //
        // send
        btn_Send.Enabled := ((not process)and(not cancel) )or
                            (M.Status in[0,1,9,77,88]   );

        if (not M.Status in[0,1,9,77,88]   ) then
        begin
            btn_Send.Enabled :=True;
        end;

        act_Edit.Enabled :=(not process)and(not cancel);

        btn_Print.Enabled :=process or(M.Status=9);

        btn_Cons.Enabled:=process or cancel;

        btn_Evento.Enabled :=process;
    end;
end;

procedure Tfrm_ManifestoList.vst_Grid1GetText(Sender: TBaseVirtualTree;
  Node: PVirtualNode; Column: TColumnIndex; TextType: TVSTTextType;
  var CellText: string);
var
  M: IManifestoDF ;
  mun: TCManifestodf01mun;
  U: UtilStr;
begin
    CellText :='';
    if Assigned(Node) then
    begin
        M :=m_Ctrl.ModelList.Items[Node.Index] ;
        mun :=M.municipios.getFirstMun(mtDescarga);
        case Column of
          00: CellText :=IntToStr(M.id) ;
          01: CellText :=M.chMDFE ;
          02: CellText :=TpEmitenteToStr(TTpEmitenteMDFe(m.tpAmbiente)) ;
          03: CellText :=IntToStr(M.numeroDoc) ;
          04: if M.Status = 0 then
              begin
                  CellText :='Não gerado XML';
              end
              else begin
                  CellText :=Format('%d|%s',[M.Status,M.motivo]) ;
              end;
          05: CellText :=FormatDateTime('dd/MM/yyyy HH:NN', M.dhEmissao);
          06: CellText :=TpEmisToStr(TpcnTipoEmissao(m.tpEmissao)) ;
          07: CellText :=M.ufeIni ;
          08: CellText :=M.ufeFim ;
          09: CellText :=U.fInt(mun.qNFe);
          10: CellText :=U.fFlt(mun.vCarga);
          11: CellText :=UnidMedToDescricaoStr(TUnidMed(M.codund));
          12: CellText :=U.fFlt(mun.qCarga);
        end;
    end;
end;

end.
